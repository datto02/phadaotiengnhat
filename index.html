<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T·∫°o file luy·ªán vi·∫øt Kanji</title>
    <meta name="description" content="C√¥ng c·ª• t·∫°o file t·∫≠p vi·∫øt Kanji, Hiragana, Katakana mi·ªÖn ph√≠.">
    <meta property="og:title" content="Luy·ªán vi·∫øt Kanji - Ph√° ƒê·∫£o Ti·∫øng Nh·∫≠t">
    <meta property="og:description" content="T·∫°o file PDF t·ª± luy·ªán vi·∫øt Kanji t·∫°i nh√† c·ª±c d·ªÖ d√†ng.">
    <meta property="og:image" content="https://i.ibb.co/dwSNXWnX/2434753923115317823.jpg">
    <meta property="og:url" content="https://phadaotiengnhat.com">
    <!--icon-->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E‚õ©Ô∏è%3C/text%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;700&display=swap');
      
      /* --- TRACING STYLE --- */
      .kanji-trace {
        font-family: 'Klee One', 'KanjiStrokeOrders', 'UD_Digi_Kyokasho', 'Noto_Serif_JP', serif;
        color: #bfbfbf; 
        -webkit-text-stroke: 0px white; 
        paint-order: stroke fill;
        position: relative;
        z-index: 10;
        line-height: 0;
        user-select: none;
      }

      /* --- DECOMPOSITION SVG STYLE --- */
      .decomp-svg {
        width: 100%;
        height: 100%;
        display: block;
      }
      .decomp-svg path {
        stroke: #000;
        stroke-width: 3px;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* --- INLINE REFERENCE SVG STYLE (BOX 1 FIX) --- */
      .ref-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      
      .ref-wrapper svg {
        width: 100% !important;
        height: 100% !important;
        display: block;
        transform-origin: center center;
        transform: translate(var(--guide-x, 0px), var(--guide-y, 0px)) scale(var(--guide-scale, 0.9));
      }
      
      .ref-wrapper text {
        font-size: 8px;
        fill: #999;
        font-family: sans-serif;
      }
      .ref-wrapper path {
        stroke: #000;
        stroke-width: 3px;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* --- PRINT CONFIGURATION --- */
      @media print {
        @page {
          size: A4 portrait;
          margin: 0;
        }
        
        html, body {
          width: 210mm;
          min-height: 297mm;
          margin: 0 !important;
          padding: 0 !important;
          background: white;
        }

        #root {
          width: 100%;
        }

        .no-print {
          display: none !important;
        }

        .a4-page {
          width: 210mm !important;
          height: 296mm !important; 
          margin: 0 !important;
          padding-top: 10mm !important;
          padding-bottom: 0 !important;
          page-break-after: always !important;
          overflow: hidden !important;
          box-shadow: none !important;
          border: none !important;
        }
        .print-layout-reset {
  overflow: visible !important; 
  height: auto !important;      
  display: block !important;   
}
::-webkit-scrollbar {
  display: none !important;
}
      }

      @media screen {
        body {
          background-color: #f3f4f6;
        }
        .a4-page {
          width: 210mm;
          height: 297mm;
          background: white;
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
          margin-bottom: 2rem;
        }
      }
/* --- 1. CLASS ·∫®N THANH TR∆Ø·ª¢T (D√πng cho Sidebar b√™n ngo√†i) --- */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }

      /* --- 2. CLASS THANH TR∆Ø·ª¢T ƒê·∫∏P (D√πng cho danh s√°ch con b√™n trong) --- */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px; 
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #ffffff;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #bfdbfe; 
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #60a5fa;
      }
      /* H·ªó tr·ª£ Firefox */
      .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #bfdbfe #ffffff;
      }
      /* --- 3. CLASS THANH TR∆Ø·ª¢T TRONG SU·ªêT --- */
      .input-scrollbar::-webkit-scrollbar {
        width: 14px; 
      }
      
      /* N·ªÅn trong su·ªët v√† c√≥ margin ƒë·ªÉ tr√°nh g√≥c bo */
      .input-scrollbar::-webkit-scrollbar-track {
        background: transparent; 
        margin-top: 8px;    
        margin-bottom: 8px; 
      }

      /* C·ª•c lƒÉn: Bo tr√≤n v√† n·∫±m l∆° l·ª≠ng ·ªü gi·ªØa */
      .input-scrollbar::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; 
        border-radius: 20px;       
        border: 5px solid transparent; 
        background-clip: content-box;  
      }

      .input-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8; 
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.35.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
    const removeAccents = (str) => {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D");
};

      const sendTelegramMessage = async (content) => {
    // 1. ƒêi·ªÅn th√¥ng tin c·ªßa b·∫°n
    const token = "8431379699:AAFOUHfPbj16ALqdPSQix-oRl0dXhnT-358"; 
    const chatId = "5227758970";

    // 2. N·ªôi dung th√¥ng b√°o (C√≥ th·ªÉ t√πy ch·ªânh theo √Ω b·∫°n)
    const message = `üöÄ *TH√îNG B√ÅO M·ªöI*\n\n` +
                  `üìù N·ªôi dung in: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}\n` +
                  `‚è∞ Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}`;

    const url = `https://api.telegram.org/bot${token}/sendMessage`;

    try {
        await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'Markdown'
            })
        });
    } catch (error) {
        console.error("L·ªói khi g·ª≠i th√¥ng b√°o Telegram:", error);
    }
};
      
      const { useState, useEffect, useMemo, useRef } = React;

      // --- FETCH DATA FROM GITHUB ---
const fetchDataFromGithub = async () => {
  try {
    const response = await fetch('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/kanji_db.json');
    if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
    return await response.json();
  } catch (error) {
    console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
    return null;
  }
};

      // --- UTILS & DATA FETCHING ---

      const getHex = (char) => char.codePointAt(0).toString(16).toLowerCase().padStart(5, '0');

      

    
      const fetchKanjiData = async (char) => {
        const hex = getHex(char);
        
        const sources = [
          `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}.svg`,
          `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg@master/kanji/${hex}-Kaisho.svg`,
          `https://cdn.jsdelivr.net/gh/parsimonhi/animCJK@master/svgsKana/${hex}.svg`,
          `https://cdn.jsdelivr.net/gh/parsimonhi/animCJK@master/svgsJa/${hex}.svg`
        ];

        for (const url of sources) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const text = await res.text();
              return { success: true, svg: text, source: url };
            }
          } catch (e) {
            continue;
          }
        }
        
        return { success: false };
      };

   
      const useKanjiSvg = (char) => {
        const [state, setState] = useState({ 
          loading: true, 
          paths: [], 
          fullSvg: null, 
          failed: false 
        });
        const mounted = useRef(true);

        useEffect(() => {
          mounted.current = true;
          if (!char) return;

          setState({ loading: true, paths: [], fullSvg: null, failed: false });

          fetchKanjiData(char).then((result) => {
            if (!mounted.current) return;

            if (result.success) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(result.svg, "image/svg+xml");
              
      
              const pathElements = Array.from(doc.querySelectorAll('path'));
              const pathData = pathElements.map(p => p.getAttribute('d')).filter(d => d);
              
           
              const svgString = new XMLSerializer().serializeToString(doc.documentElement);

              setState({
                loading: false,
                paths: pathData,
                fullSvg: svgString,
                failed: false
              });
            } else {
              setState({
                loading: false,
                paths: [],
                fullSvg: null,
                failed: true
              });
            }
          });

          return () => { mounted.current = false; };
        }, [char]);

        return state;
      };

const useKanjiReadings = (char, active) => {
    const [readings, setReadings] = useState({ on: '', kun: '' });
    
    useEffect(() => {
        if (!char || !active) return;
        
        // G·ªçi API l·∫•y d·ªØ li·ªáu t·ª´ web
        fetch(`https://kanjiapi.dev/v1/kanji/${char}`)
            .then(res => res.json())
            .then(data => {
                if (data) {
                    setReadings({
                        on: data.on_readings?.join(', ') || '---',
                        kun: data.kun_readings?.join(', ') || '---'
                    });
                }
            })
            .catch(() => setReadings({ on: '---', kun: '---' }));
    }, [char, active]);

    return readings;
};
  
 const HeaderSection = ({ char, paths, loading, failed, config, dbData }) => {
  const readings = useKanjiReadings(char, config.showOnKun);
  
  if (loading) return <div className="h-[22px] w-full animate-pulse bg-gray-100 rounded mb-1"></div>;
  if (failed) return <div className="h-[22px] w-full mb-1"></div>;

  // Th√™m ti·ªÅn t·ªë dbData. v√†o tr∆∞·ªõc c√°c bi·∫øn
const info = dbData.KANJI_DB[char] || dbData.ALPHABETS.hiragana[char] || dbData.ALPHABETS.katakana[char];

const isJLPT = dbData.KANJI_LEVELS.N5.includes(char) || 
               dbData.KANJI_LEVELS.N4.includes(char) || 
               dbData.KANJI_LEVELS.N3.includes(char) || 
               dbData.KANJI_LEVELS.N2.includes(char) || 
               dbData.KANJI_LEVELS.N1.includes(char);

  return (
    <div 
      className="flex flex-row items-end px-1 mb-1 h-[22px] overflow-hidden border-b border-transparent"
      style={{ width: '184mm', minWidth: '184mm', maxWidth: '184mm' }}
    >
      {/* 1. √ÇM H√ÅN VI·ªÜT + NGHƒ®A (Lu√¥n hi·ªán n·∫øu c√≥ d·ªØ li·ªáu) */}
      {info && (
        <div className="flex-shrink-0 mr-4 flex items-baseline gap-2 mb-[3px]">
          <span className="font-bold text-sm leading-none text-black whitespace-nowrap uppercase">
            {info.sound}
          </span>
          {info.meaning && info.meaning.trim() !== "" && (
            <span className="text-[12px] font-normal text-black leading-none whitespace-nowrap">
              ({info.meaning})
            </span>
          )}
        </div>
      )}

      {/* 2. PH·∫¶N LOGIC THAY ƒê·ªîI THEO N√öT G·∫†T */}
      <div className="flex-1 min-w-0 h-[22px]"> 
        {(() => {
          // TR∆Ø·ªúNG H·ª¢P 1: N·∫øu n√∫t g·∫°t ƒëang T·∫ÆT (M·∫∑c ƒë·ªãnh)
          // Hi·ªán th·ª© t·ª± n√©t v·∫Ω cho T·∫§T C·∫¢ c√°c ch·ªØ (Kanji, Kana...)
          if (!config.showOnKun) {
            return (
              <div className="h-full flex items-center flex-wrap gap-1">
                {paths.map((_, i) => (
                  <div key={i} className="w-[22px] h-[22px] flex-shrink-0">
                    <svg viewBox="0 0 109 109" className="decomp-svg">
                      {paths.slice(0, i + 1).map((d, pIndex) => (
                        <path key={pIndex} d={d} />
                      ))}
                    </svg>
                  </div>
                ))}
              </div>
            );
          }

          // TR∆Ø·ªúNG H·ª¢P 2: N·∫øu n√∫t g·∫°t ƒëang B·∫¨T
          // A. N·∫øu l√† Kanji thu·ªôc N1-N5: Hi·ªán √¢m On/Kun
          if (isJLPT) {
            return (
              <div className="h-full flex items-end pb-[3px] text-[12px] text-black italic w-full leading-none whitespace-nowrap">
              <div className="truncate w-full">
              <span className="font-bold text-black mr-1 uppercase">On:</span>
              <span className="mr-3 not-italic font-medium">{readings.on || '---'}</span>
              <span className="font-bold text-black mr-1 uppercase">Kun:</span>
              <span className="not-italic font-medium">{readings.kun || '---'}</span>
              </div>
              </div>
            );
          }

          // B. N·∫øu KH√îNG ph·∫£i Kanji N1-N5 (Hiragana, Katakana, ch·ªØ kh√°c): ·∫®n ho√†n to√†n n√©t v·∫Ω
          return null;
        })()}
      </div>
    </div>
  );
};
     // 2. Grid Box
      const GridBox = ({ char, type, config, index, svgData, failed }) => {
        const isReference = type === 'reference';
        const showTrace = index < config.traceCount;
        const { gridType, gridOpacity } = config; 

   
        const gridColor = `rgba(0, 0, 0, ${gridOpacity})`;

        const refStyle = isReference ? {
          '--guide-scale': config.guideScale,
          '--guide-x': `${config.guideX}px`,
          '--guide-y': `${config.guideY}px`
        } : {};

        return (
          // Main Container: D√πng style ƒë·ªÉ ch·ªânh m√†u vi·ªÅn ƒë·ªông theo opacity
          <div 
            className="relative w-[16mm] h-[16mm] border-r border-b box-border flex justify-center items-center overflow-hidden bg-transparent"
            style={{ borderColor: gridColor }} 
          >
            
            {/* Grid Lines */}
            <div className="absolute inset-0 pointer-events-none z-0">
               {gridType !== 'blank' && (
                <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                  {/* Cross Lines */}
                  <line x1="50" y1="0" x2="50" y2="100" stroke="black" strokeOpacity={gridOpacity} strokeWidth="0.5" strokeDasharray="4 4" />
                  <line x1="0" y1="50" x2="100" y2="50" stroke="black" strokeOpacity={gridOpacity} strokeWidth="0.5" strokeDasharray="4 4" />
                </svg>
               )}
            </div>

            {/* Content  */}
            {char && (
              <>
                {isReference && (
                  <div className="relative z-20 w-full h-full flex items-center justify-center p-[1px]">
                      {!failed && svgData ? (
                        <div className="ref-wrapper" style={refStyle} dangerouslySetInnerHTML={{ __html: svgData }} />
                      ) : (
                        <span className="kanji-trace !text-black flex justify-center items-center h-full w-full"
                          style={{ fontSize: `${config.fontSize}pt`, color: 'black', transform: `translateY(${config.verticalOffset}px)`, textShadow: 'none', webkitTextStroke: '0' }}>
                          {char}
                        </span>
                      )}
                  </div>
                )}

{!isReference && showTrace && (
  <span className="kanji-trace"
    style={{
      fontSize: `${config.fontSize}pt`,
      transform: `translateY(${config.verticalOffset}px)`,
      color: `rgba(0, 0, 0, ${config.traceOpacity})`,
      fontFamily: config.fontFamily
    }}
  >
    {char}
  </span>
)}
              </>
            )}
          </div>
        );
      };

     // 3. WorkbookRow 
     const WorkbookRow = ({ char, config, dbData }) => {
  const { loading, paths, fullSvg, failed } = useKanjiSvg(char);
  const boxes = Array.from({ length: 12 }, (_, i) => i);
  const gridBorderColor = `rgba(0, 0, 0, ${config.gridOpacity})`;

  return (
    <div className="flex flex-col w-full px-[8mm]">
      <HeaderSection 
        char={char} 
        paths={paths} 
        loading={loading} 
        failed={failed} 
        config={config} 
        dbData={dbData}
      />
      
      <div className="flex border-l border-t w-fit" style={{ borderColor: gridBorderColor }}>
        {boxes.map((i) => (
          <GridBox
            key={i}
            index={i}
            char={char}
            type={i === 0 ? 'reference' : 'trace'}
            config={config}
            svgData={fullSvg}
            failed={failed}
          />
        ))}
      </div>
    </div>
  );
};

      // 4. Page Layout
      const Page = ({ chars, config, dbData }) => {
      const isSample = !config.text || config.text.trim().length === 0;
        return (
          <div className="a4-page mx-auto relative flex flex-col pt-[15mm] pl-[3mm] bg-white">
          {(!config.text || config.text.trim().length === 0) && (
    <div className="w-full max-w-[210mm] mb-5 text-left pl-[8mm]">
        <div className="flex items-end gap-3">
            {/* Logic: Ch·ªâ hi·ªán khi n·ªôi dung TR·ªêNG. N·∫øu c√≥ ch·ªØ th√¨ ·∫©n lu√¥n */}
            {(!config.text || config.text.trim().length === 0) && (
                <>
                   <span className="text-2xl font-black text-gray-600 uppercase leading-none">B·∫¢N M·∫™U</span>
                   <span className="text-sm text-gray-500 font-medium pb-1">(h√£y nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ t·∫°o file luy·ªán vi·∫øt)</span>
                </>
            )}
        </div>
    </div>
)}
            <div className="flex flex-col gap-[4mm]">
              {chars.map((char, index) => (
                <WorkbookRow
                  key={`${index}-${char}`}
                  char={char}
                  config={config}
                  dbData={dbData}
                />
              ))}
            </div>

            {/* Branding Footer */}
            <div className="absolute bottom-[5mm] left-[12.5mm] text-gray-400 text-xs font-sans">
            {/* D√≤ng 1 */}
  <div className="text-[10px]">
    ¬© B·∫£n quy·ªÅn thu·ªôc <span className="font-bold text-gray-500">Ph√° ƒê·∫£o Ti·∫øng Nh·∫≠t</span> 
    <span> (<span className="font-bold italic text-gray-500">tiktok @phadaotiengnhat</span>)</span>
  </div>
  
  {/* D√≤ng 2 */}
  <div className="text-[10px] mt-0.5">
    T√†i li·ªáu mi·ªÖn ph√≠ - Nghi√™m c·∫•m m·ªçi h√†nh vi mua b√°n th∆∞∆°ng m·∫°i
  </div>
            </div>
          </div>
        );
      };

// 5. Sidebar (Phi√™n b·∫£n: Final)
      const Sidebar = ({ config, onChange, onPrint, isMenuOpen, setIsMenuOpen, isConfigOpen, setIsConfigOpen, isCafeModalOpen, setIsCafeModalOpen, showMobilePreview, setShowMobilePreview, dbData }) => {
        const scrollRef = useRef(null);
        const [searchResults, setSearchResults] = useState([]);
        const [activeIndex, setActiveIndex] = useState(0); 
        const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
        const [isDocsModalOpen, setIsDocsModalOpen] = useState(false);

        // --- CH·∫∂N TUY·ªÜT ƒê·ªêI CTRL + P (KH√îNG C√ì G√å X·∫¢Y RA) ---
      useEffect(() => {
        const handleKeyDown = (e) => {
          // Ki·ªÉm tra Ctrl + P (Win) ho·∫∑c Command + P (Mac)
          if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 'P')) {
            e.preventDefault(); // Ch·∫∑n tr√¨nh duy·ªát m·ªü b·∫£ng in
            e.stopPropagation(); // Ch·∫∑n s·ª± ki·ªán lan truy·ªÅn
            return false; // K·∫øt th√∫c ngay l·∫≠p t·ª©c, kh√¥ng l√†m g√¨ c·∫£
          }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);
        
// --- CH·∫∂N CU·ªòN TRANG KHI M·ªû MODAL ---
useEffect(() => {
    // N·∫øu khung In ho·∫∑c khung T√†i li·ªáu ƒëang m·ªü
    if (isPrintModalOpen || isDocsModalOpen) {
        document.body.style.overflow = 'hidden'; // Kh√≥a cu·ªôn
    } else {
        document.body.style.overflow = 'unset';  // M·ªü l·∫°i cu·ªôn b√¨nh th∆∞·ªùng
    }
    // D·ªçn d·∫πp khi t·∫Øt
    return () => { document.body.style.overflow = 'unset'; };
}, [isPrintModalOpen, isDocsModalOpen]);


        useEffect(() => {
    if (scrollRef.current) {
        const activeItem = scrollRef.current.childNodes[activeIndex];
        if (activeItem) {
            // T·ª± ƒë·ªông cu·ªôn ƒë·∫øn m·ª•c ƒëang ch·ªçn (block: 'nearest' ƒë·ªÉ m∆∞·ª£t h∆°n)
            activeItem.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest'
            });
        }
    }
}, [activeIndex]); // Ch·∫°y l·∫°i m·ªói khi activeIndex thay ƒë·ªïi

        // --- STATE QU·∫¢N L√ù ---
        const [isLoading, setIsLoading] = useState(false);
        const [progress, setProgress] = useState(0);
        const [searchTerm, setSearchTerm] = useState('');

        // --- H√ÄM KI·ªÇM TRA C·∫§P ƒê·ªò JLPT ---
const getJLPTLevel = (char) => {
    if (dbData.KANJI_LEVELS.N5.includes(char)) return 'N5';
    if (dbData.KANJI_LEVELS.N4.includes(char)) return 'N4';
    if (dbData.KANJI_LEVELS.N3.includes(char)) return 'N3';
    if (dbData.KANJI_LEVELS.N2.includes(char)) return 'N2';
    if (dbData.KANJI_LEVELS.N1.includes(char)) return 'N1';
    return null;
};

const levelColors = {
    N5: 'bg-green-100 text-green-700 border-green-200 hover:bg-green-600 hover:text-white hover:border-green-600',
    N4: 'bg-blue-100 text-blue-700 border-blue-200 hover:bg-blue-600 hover:text-white hover:border-blue-600',
    N3: 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-600 hover:text-white hover:border-orange-600',
    N2: 'bg-purple-100 text-purple-700 border-purple-200 hover:bg-purple-600 hover:text-white hover:border-purple-600',
    N1: 'bg-red-100 text-red-700 border-red-200 hover:bg-red-600 hover:text-white hover:border-red-600'
};

        
        // Menu Popup & Ref
        const [isUtilsOpen, setIsUtilsOpen] = useState(false);
        const [isFilterMenuOpen, setIsFilterMenuOpen] = useState(false);
        const filterRef = useRef(null);
        const quickMenuRef = useRef(null); // TH√äM: Ref cho menu Ch·ªçn nhanh
        const utilsMenuRef = useRef(null); // TH√äM: Ref cho menu Ti·ªán √≠ch
        const cafeModalRef = useRef(null);
        const searchInputRef = useRef(null); // T·∫°o "ƒë·ªãa ch·ªâ" cho √¥ nh·∫≠p li·ªáu
        const configMenuRef = useRef(null);
        // Bi·∫øn ki·ªÉm so√°t b·ªô g√µ IME (Quan tr·ªçng)
        const isComposing = useRef(false);

        const [randomCount, setRandomCount] = useState(10); 

        // State hi·ªÉn th·ªã n·ªôi b·ªô
        const [localText, setLocalText] = useState(config.text);

        // T√πy ch·ªçn b·ªô l·ªçc
        const [filterOptions, setFilterOptions] = useState({
            hiragana: true,
            katakana: true,
            kanji: true,
            removeDuplicates: false 
        });

        // --- H√ÄM T·∫†O PLACEHOLDER ---
        const getDynamicPlaceholder = () => {
            const labels = [];
            if (filterOptions.kanji) labels.push("Êº¢Â≠ó");       
            if (filterOptions.hiragana) labels.push("„Å≤„Çâ„Åå„Å™"); 
            if (filterOptions.katakana) labels.push("„Ç´„Çø„Ç´„Éä"); 
            
            if (labels.length === 0) return "Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 lo·∫°i ch·ªØ...";
            return labels.join(", ");
        };

        // --- 1. CLICK RA NGO√ÄI ƒê·ªÇ ƒê√ìNG MENU ---
       // --- X·ª¨ L√ù CLICK RA NGO√ÄI ƒê·ªÇ ƒê√ìNG MENU ---
useEffect(() => {
    function handleClickOutside(event) {
        // 1. X·ª≠ l√Ω B·ªô l·ªçc (Filter)
        if (filterRef.current && !filterRef.current.contains(event.target)) {
            setIsFilterMenuOpen(false);
        }

        // 2. X·ª≠ l√Ω "Ch·ªçn nhanh" (Quick Select) - T·ª± ƒë√≥ng khi click ra ngo√†i
        if (isMenuOpen && quickMenuRef.current && !quickMenuRef.current.contains(event.target)) {
            setIsMenuOpen(false);
        }

        // 3. X·ª≠ l√Ω "Ti·ªán √≠ch" (Utils) - T·ª± ƒë√≥ng khi click ra ngo√†i
        if (isUtilsOpen && utilsMenuRef.current && !utilsMenuRef.current.contains(event.target)) {
            setIsUtilsOpen(false);
        }
        if (isCafeModalOpen && cafeModalRef.current && !cafeModalRef.current.contains(event.target)) {
            setIsCafeModalOpen(false);
        }
        // 5. M·ªöI: X·ª≠ l√Ω "T√πy ch·ªânh" - T·ª± ƒë√≥ng khi click ra ngo√†i
        if (isConfigOpen && configMenuRef.current && !configMenuRef.current.contains(event.target)) {
            setIsConfigOpen(false);
        }

    }

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
}, [isMenuOpen, isUtilsOpen, isFilterMenuOpen, isCafeModalOpen, isConfigOpen]); // Th√™m dependencies ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi nh·∫•t

        // --- 2. ƒê·ªíNG B·ªò D·ªÆ LI·ªÜU T·ª™ NGO√ÄI ---
        useEffect(() => {
            const currentClean = localText ? localText.replace(/[a-zA-Z]/g, '') : '';
            if (currentClean !== config.text) {
                setLocalText(config.text);
            }
        // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [config.text]);

        const handleChange = (key, value) => {
          onChange({ ...config, [key]: value });
        };

        const shuffleString = (str) => {
            const arr = [...str];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr.join('');
        };

        // --- H√ÄM TR·ª¢ GI√öP: REGEX ---
        const getAllowedRegexString = (options, allowLatin = false) => {
            let ranges = "\\s"; 
            if (allowLatin) ranges += "a-zA-Z"; // Latinh lu√¥n ƒë∆∞·ª£c ph√©p ·ªü input

            if (options.hiragana) ranges += "\\u3040-\\u309F";
            if (options.katakana) ranges += "\\u30A0-\\u30FF";
            if (options.kanji)    ranges += "\\u4E00-\\u9FAF\\u3400-\\u4DBF\\u2E80-\\u2FDF\\uF900-\\uFAFF"; 
            return ranges;
        };
        // --- H√ÄM TR·ª¢ GI√öP: X√ìA TR√ôNG L·∫∂P ---
          const getUniqueChars = (str) => {
              return Array.from(new Set(str)).join('');
              };

        // --- 3. X·ª¨ L√ù CHECKBOX ---
        const handleFilterChange = (key) => {
            const newOptions = { ...filterOptions, [key]: !filterOptions[key] };
            setFilterOptions(newOptions);
            
            let newText = localText;

            // X·ª≠ l√Ω c√°c √¥ Hiragana/Katakana/Kanji (nh∆∞ c≈©)
            if (['hiragana', 'katakana', 'kanji'].includes(key) && filterOptions[key] === true) {
                const allowedString = getAllowedRegexString(newOptions, true); 
                const regex = new RegExp(`[^${allowedString}]`, 'g');
                newText = newText.replace(regex, '');
            }

            // X·ª≠ l√Ω √¥ X√≥a tr√πng l·∫∑p (M·ªöI)
            if (newOptions.removeDuplicates) {
                newText = getUniqueChars(newText);
            }
            
            setLocalText(newText);
            handleChange('text', newText.replace(/[a-zA-Z]/g, ''));
        };

// --- 4. N√öT X√ìA LATINH + D·ªíN D√íNG (PHI√äN B·∫¢N X√ìA S·∫†CH S√ÄNH SANH) ---
        const handleRemoveLatinManual = () => {
            if (!localText) return;
            let cleaned = localText;
            
            // 1. X√≥a ch·ªØ c√°i Latinh
            cleaned = cleaned.replace(/[a-zA-Z]/g, '');
            
            // 2. X√≥a h·∫øt d·∫•u xu·ªëng d√≤ng (Enter) -> Thay b·∫±ng r·ªóng ''
            cleaned = cleaned.replace(/[\n\r]+/g, '');
            
            // 3. X√≥a h·∫øt c√°c lo·∫°i d·∫•u c√°ch (th∆∞·ªùng, tab, Nh·∫≠t) -> Thay b·∫±ng r·ªóng ''
            // Regex n√†y bao g·ªìm: d·∫•u c√°ch th∆∞·ªùng ( ), d·∫•u c√°ch Nh·∫≠t („ÄÄ), v√† tab (\t)
            cleaned = cleaned.replace(/[ „ÄÄ\t]+/g, ''); 
            
            // C·∫Øt kho·∫£ng tr·∫Øng th·ª´a 2 ƒë·∫ßu (n·∫øu c√≤n s√≥t)
            cleaned = cleaned.trim();

            setLocalText(cleaned);
            handleChange('text', cleaned); 
        };

        // --- 5. X·ª¨ L√ù NH·∫¨P LI·ªÜU (ƒê√É FIX L·ªñI IME) ---
      // --- 5. X·ª¨ L√ù NH·∫¨P LI·ªÜU (REAL-TIME FILTER) ---
        const handleInputText = (e) => {
            const rawInput = e.target.value;

            // N·∫øu ƒëang l∆° l·ª≠ng g√µ b·ªô g√µ (IME) th√¨ c·ª© ƒë·ªÉ hi·ªán
            if (isComposing.current) {
                setLocalText(rawInput);
                return;
            }
            
            // 1. L·ªçc k√Ω t·ª± r√°c (s·ªë, icon...)
            const allowedString = getAllowedRegexString(filterOptions, true);
            const blockRegex = new RegExp(`[^${allowedString}]`, 'g');
            let validForInput = rawInput.replace(blockRegex, '');

            // 2. LOGIC QUAN TR·ªåNG: L·ªçc tr√πng ngay l·∫≠p t·ª©c
            if (filterOptions.removeDuplicates) {
                validForInput = getUniqueChars(validForInput);
            }

            setLocalText(validForInput);
            handleChange('text', validForInput.replace(/[a-zA-Z]/g, ''));
        };

        const handleCompositionStart = () => {
            isComposing.current = true;
        };

        const handleCompositionEnd = (e) => {
            isComposing.current = false;
            
            // L·∫•y to√†n b·ªô n·ªôi dung trong √¥ nh·∫≠p l√∫c n√†y
            const rawInput = e.target.value;
            
            // 1. L·ªçc r√°c
            const allowedString = getAllowedRegexString(filterOptions, true);
            const blockRegex = new RegExp(`[^${allowedString}]`, 'g');
            let validForInput = rawInput.replace(blockRegex, '');

            // 2. LOGIC QUAN TR·ªåNG: L·ªçc tr√πng ngay khi ch·ªët ch·ªØ
            if (filterOptions.removeDuplicates) {
                validForInput = getUniqueChars(validForInput);
            }

            setLocalText(validForInput);
            handleChange('text', validForInput.replace(/[a-zA-Z]/g, ''));
        };
// Th√™m tham s·ªë type (m·∫∑c ƒë·ªãnh l√† 'kanji')
const handleLoadFromGithub = async (url, type = 'kanji') => {
    setProgress(0);
    setIsLoading(true);     
    setIsMenuOpen(false);   
    
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu t·ª´ ${url}`);
        }

        const rawText = await response.text();
        const cleanText = rawText.replace(/["\n\r\s,\[\]]/g, '');

        if (!cleanText) {
             alert("File d·ªØ li·ªáu r·ªóng!");
             setIsLoading(false);
             return;
        }

      
        setFilterOptions(prev => ({ ...prev, [type]: true })); 
        
        setProgress(30);
        setTimeout(() => setProgress(100), 300);

        setTimeout(() => {
            setLocalText(cleanText);              
            onChange({ ...config, text: cleanText }); 
            setIsLoading(false);                  
        }, 500);

    } catch (error) {
        console.error("L·ªói:", error);
        alert("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng truy·ªÅn ho·∫∑c link GitHub.");
        setIsLoading(false);
    }
};
        // --- H√ÄM M·ªöI: L·∫•y ng·∫´u nhi√™n Kanji t·ª´ GitHub ---
        const handleRandomLoadFromGithub = async (level) => {
            // 1. Ki·ªÉm tra s·ªë l∆∞·ª£ng
            if (randomCount === '' || randomCount <= 0) {
                alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ch·ªØ c·∫ßn l·∫•y!");
                return;
            }
            setProgress(0);

            // 2. T·∫°o link file: kanjin5.json...
            const fileName = `kanji${level.toLowerCase()}.json`; 
            const url = `https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/${fileName}`;

            setIsLoading(true);
            setIsUtilsOpen(false); // ƒê√≥ng menu Ti·ªán √≠ch
            
            try {
                // 3. T·∫£i file v·ªÅ
                const response = await fetch(url);
                if (!response.ok) throw new Error("L·ªói t·∫£i file");
                
                const rawText = await response.text();
                const cleanText = rawText.replace(/["\n\r\s]/g, '');

                if (!cleanText) {
                     alert("File d·ªØ li·ªáu r·ªóng!");
                     setIsLoading(false);
                     return;
                }

                // 4. X√°o tr·ªôn v√† c·∫Øt l·∫•y s·ªë l∆∞·ª£ng c·∫ßn thi·∫øt
                const shuffled = shuffleString(cleanText); // H√†m shuffleString c√≥ s·∫µn trong code c≈© r·ªìi
                let count = randomCount > 50 ? 50 : randomCount;
                const selectedChars = shuffled.slice(0, count);

                // 5. Hi·ªÉn th·ªã
                setFilterOptions(prev => ({ ...prev, kanji: true }));
                
                setProgress(30);
                setTimeout(() => setProgress(100), 300);

                setTimeout(() => {
                    setLocalText(selectedChars);
                    onChange({ ...config, text: selectedChars });
                    setIsLoading(false);
                }, 500);

            } catch (error) {
                console.error(error);
                alert(`Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ${level}. Ki·ªÉm tra l·∫°i m·∫°ng ho·∫∑c link GitHub.`);
                setIsLoading(false);
            }
        };
        // --- 6. X·ª¨ L√ù R·ªúI TAY ---
        const handleBlurText = () => {
            if (!localText) return;
            let cleaned = localText; 
            cleaned = cleaned.replace(/[ \t]+/g, ' '); 
            cleaned = cleaned.replace(/(\n\s*){2,}/g, '\n'); 
            cleaned = cleaned.trim();

            if (filterOptions.removeDuplicates) {
                cleaned = getUniqueChars(cleaned);
            }

            if (cleaned !== localText) {
                setLocalText(cleaned);
                handleChange('text', cleaned.replace(/[a-zA-Z]/g, ''));
            }
        };

        // --- C√ÅC H√ÄM TI·ªÜN √çCH KH√ÅC ---
        const handleSmartLoad = (content, type = null) => {
            if (!content) return;
            setIsLoading(true); setIsMenuOpen(false); setIsUtilsOpen(false); setIsConfigOpen(false); setProgress(0);
            
            if (type) setFilterOptions(prev => ({ ...prev, [type]: true }));
            else if (type === 'all') setFilterOptions(prev => ({ ...prev, kanji: true }));

            const interval = setInterval(() => {
                setProgress((prev) => { if (prev >= 90) return 90; return prev + Math.floor(Math.random() * 10) + 5; });
            }, 80);
            setTimeout(() => {
                setLocalText(content);
                onChange({ ...config, text: content });
                clearInterval(interval); setProgress(100); setTimeout(() => setIsLoading(false), 200);
            }, 600);
        };


        const handleShuffleCurrent = () => {
            if (!config.text) { alert("Ch∆∞a c√≥ n·ªôi dung!"); return; }
            handleSmartLoad(shuffleString(config.text));
        };

        // H√†m x·ª≠ l√Ω t√¨m ki·∫øm th·ªùi gian th·ª±c
 const handleSearchRealtime = (val) => {
    setSearchTerm(val);
    const query = val.toLowerCase().trim();
    const queryNoAccent = removeAccents(query);
    
    if (!query) {
        setSearchResults([]);
        return;
    }

    const matches = [];
    const processData = (source, type) => {
        Object.entries(source).forEach(([char, info]) => {
            if (info.sound) {
                const sound = info.sound.toLowerCase();
                const soundNoAccent = removeAccents(sound);

                // T√≠nh to√°n tr·ªçng s·ªë ∆∞u ti√™n (C√†ng th·∫•p c√†ng ƒë·ª©ng ƒë·∫ßu)
                let priority = 99;

                if (sound === query) priority = 1; // 1. Kh·ªõp ch√≠nh x√°c (An -> AN)
                else if (soundNoAccent === queryNoAccent) priority = 2; // 2. Kh·ªõp ch√≠nh x√°c kh√¥ng d·∫•u (An -> √ÅN)
                else if (sound.includes(query)) priority = 3; // 3. Ch·ª©a v·∫ßn ch√≠nh x√°c (An -> SAN)
                else if (soundNoAccent.includes(queryNoAccent)) priority = 4; // 4. Ch·ª©a v·∫ßn kh√¥ng d·∫•u (An -> H√ÅN)

                if (priority < 99) {
                    matches.push({ char, ...info, type, priority, sound });
                }
            }
        });
    };

    processData(dbData.KANJI_DB, 'kanji');

    // S·∫Øp x·∫øp theo tr·ªçng s·ªë, n·∫øu c√πng tr·ªçng s·ªë th√¨ x·∫øp theo Alphabet
    matches.sort((a, b) => {
        if (a.priority !== b.priority) return a.priority - b.priority;
        return a.sound.localeCompare(b.sound);
    });

    setSearchResults(matches.slice(0, 20));
    setActiveIndex(0); // Reset v·ªÅ v·ªã tr√≠ ƒë·∫ßu ti√™n
};

       // --- H√ÄM CH·ªåN CH·ªÆ T·ª™ G·ª¢I √ù (ƒê√É FIX L·ªñI TR√ôNG L·∫∂P) ---
const selectResult = (item) => {
    // 1. T·∫°o chu·ªói m·ªõi b·∫±ng c√°ch c·ªông ch·ªØ v·ª´a ch·ªçn v√†o cu·ªëi
    let newText = config.text + item.char;

    // 2. KI·ªÇM TRA: N·∫øu ƒëang b·∫≠t t√≠nh nƒÉng "X√≥a tr√πng l·∫∑p" th√¨ l·ªçc chu·ªói ngay
    if (filterOptions.removeDuplicates) {
        newText = getUniqueChars(newText);
    }

    // 3. C·∫≠p nh·∫≠t v√†o giao di·ªán v√† d·ªØ li·ªáu h·ªá th·ªëng
    setLocalText(newText);
    handleChange('text', newText);
    
    // 4. Reset √¥ t√¨m ki·∫øm
    setSearchTerm('');
    setSearchResults([]);
    setActiveIndex(0);
    
    // 5. T·ª± ƒë·ªông b·∫≠t b·ªô l·ªçc t∆∞∆°ng ·ª©ng 
    if (item.type === 'kanji') setFilterOptions(p => ({...p, kanji: true}));
    else if (item.char.match(/[\u3040-\u309F]/)) setFilterOptions(p => ({...p, hiragana: true}));
    else setFilterOptions(p => ({...p, katakana: true}));
};
        
        const toggleMenu = (menuName) => {
            setIsCafeModalOpen(false); 
            setIsFilterMenuOpen(false); 
            if (menuName === 'quick') { setIsMenuOpen(!isMenuOpen); setIsUtilsOpen(false); setIsConfigOpen(false); }
            else if (menuName === 'utils') { setIsUtilsOpen(!isUtilsOpen); setIsMenuOpen(false); setIsConfigOpen(false); }
            else if (menuName === 'config') { setIsConfigOpen(!isConfigOpen); setIsMenuOpen(false); setIsUtilsOpen(false); }
        };

        // Check warning ƒë·ªÉ ƒë·ªïi font placeholder
        const isWarningMode = !filterOptions.hiragana && !filterOptions.katakana && !filterOptions.kanji;

        return (
          <div className="w-full md:w-96 bg-white shadow-xl p-6 flex flex-col gap-6 h-auto md:h-screen md:overflow-y-auto relative md:sticky top-0 border-r border-gray-200 z-50 hide-scrollbar">
            
           {/* HEADER */}
            <div className="mb-4 pb-3 border-b border-gray-100"> 
              <h1 className="text-xl font-bold text-gray-800 flex items-center gap-1.5 mb-1">
                 <svg className="w-5 h-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                T·∫†O FILE LUY·ªÜN VI·∫æT KANJI
              </h1>
            </div>

            <div className="space-y-6 flex-1">
                
            {/* T√åM KI·∫æM TH√îNG MINH (B∆Ø·ªöC 3) */}
<div className="space-y-1.5 pb-2 mb-2 relative">
    <div className="flex gap-2">
<div className="relative flex-1">
    {/* Icon K√≠nh l√∫p (B√™n tr√°i) */}
    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-500">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
        </svg>
    </div>
    
    {/* √î Input */}
    <input 
        ref={searchInputRef}
        type="text" 
        value={searchTerm} 
        className="w-full pl-10 pr-10 py-2.5 border border-indigo-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-indigo-50 text-indigo-900 placeholder-indigo-400 font-bold font-sans" 
        placeholder="T√¨m Kanji theo √¢m H√°n Vi·ªát" 
        onChange={(e) => handleSearchRealtime(e.target.value)} 
        onKeyDown={(e) => {
            if (searchResults.length > 0) {
                if (e.key === 'ArrowDown') { 
                    e.preventDefault(); 
                    setActiveIndex(prev => (prev < searchResults.length - 1 ? prev + 1 : 0)); 
                } else if (e.key === 'ArrowUp') { 
                    e.preventDefault(); 
                    setActiveIndex(prev => (prev > 0 ? prev - 1 : searchResults.length - 1)); 
                } else if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    selectResult(searchResults[activeIndex]); 
                }
            }
        }}
    />

    {/* N√öT X ƒê·ªÇ X√ìA (M·ªöI TH√äM) - Ch·ªâ hi·ªán khi ƒëang c√≥ ch·ªØ */}
    {searchTerm && (
        <button 
            onClick={() => {
                setSearchTerm('');    // X√≥a ch·ªØ
                setSearchResults([]); // ƒê√≥ng danh s√°ch g·ª£i √Ω
                searchInputRef.current.focus();
            }}
            className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-indigo-600 transition-colors"
            title="X√≥a t√¨m ki·∫øm"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    )}
</div>
    </div>

    {/* DROPDOWN K·∫æT QU·∫¢ G·ª¢I √ù - CH·ªà HI·ªÜN KHI C√ì K·∫æT QU·∫¢ */}
    {searchResults.length > 0 && (
        <div 
        ref={scrollRef}
        className="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl z-[70] max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in zoom-in-95 duration-200">
{searchResults.map((item, idx) => {
    const level = getJLPTLevel(item.char); // Ki·ªÉm tra c·∫•p ƒë·ªô N1-N5

    return (
        <div 
            key={idx} 
            onClick={() => selectResult(item)}
            className={`flex items-center gap-3 p-3 cursor-pointer border-b border-gray-50 last:border-none transition-colors group ${
                idx === activeIndex ? 'bg-indigo-100' : 'bg-white hover:bg-indigo-50'
            }`}
        >
            {/* Ch·ªØ hi·ªÉn th·ªã */}
            <span className="text-2xl font-['Klee_One'] text-black group-hover:scale-110 transition-transform">
                {item.char}
            </span>

            {/* √Çm H√°n v√† nghƒ©a */}
            <div className="flex flex-col">
                <span className="text-[11px] font-black text-indigo-600 uppercase leading-tight">
                    {item.sound}
                </span>
                {item.meaning && (
                    <span className="text-[10px] text-gray-400 font-medium leading-tight">
                        {item.meaning}
                    </span>
                )}
            </div>

            {/* NH√ÉN M√ÅC (Badge) */}
            <div className="ml-auto">
                {level ? (
                    /* N·∫øu thu·ªôc danh s√°ch Kanji N1-N5 */
                    <div className={`px-1.5 py-0.5 rounded text-[9px] font-black border transition-all duration-200 ${levelColors[level]}`}>
                        {level}
                    </div>
                ) : (
                    /* N·∫øu KH√îNG thu·ªôc N1-N5 -> M·∫∑c ƒë·ªãnh hi·ªán m√°c B·ªò TH·ª¶ */
                    <div className="px-1.5 py-0.5 rounded text-[9px] font-black border bg-gray-100 text-gray-500 border-gray-200 uppercase transition-all duration-200 hover:bg-gray-500 hover:text-white hover:border-gray-500 cursor-default">
                        B·ªô th·ªß
                    </div>
                )}
            </div>
        </div>
    );
})}
        </div>
    )}

</div>

                {/* KHUNG NH·∫¨P LI·ªÜU */}
                <div className="space-y-2 pt-2">
                  {/* --- TI√äU ƒê·ªÄ & C√ÅC N√öT (ƒê√É CH·ªàNH S·ª¨A GIAO DI·ªÜN) --- */}
                  <div className="flex items-center justify-between mb-2">
                    <label className="text-sm font-medium text-gray-700 font-sans">Nh·∫≠p d·ªØ li·ªáu</label>
                    
                    {/* C·ª§M N√öT B·ªò L·ªåC V√Ä X√ìA */}
                    <div className="flex items-center gap-3 relative">
                        
                        {/* 1. N√öT M·ªû B·ªò L·ªåC */}
                        <div className="relative" ref={filterRef}>
                            <button 
                                onClick={() => setIsFilterMenuOpen(!isFilterMenuOpen)}
                                className={`flex items-center gap-1 text-[10px] font-bold px-2 py-1 rounded transition-colors ${isFilterMenuOpen ? 'bg-indigo-100 text-indigo-700' : 'text-gray-600 hover:bg-gray-50 hover:text-indigo-700'}`}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                                B·ªô l·ªçc
                            </button>

                            {/* POPUP MENU B·ªò L·ªåC */}
                            {isFilterMenuOpen && (
                                <div className="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-200 rounded-xl shadow-2xl p-3 z-50 animate-in fade-in zoom-in-95 duration-200">
                                    <div className="flex items-center justify-between mb-2 pb-2 border-b border-gray-100">
                                        <span className="text-[10px] font-bold text-gray-500 uppercase">B·ªò L·ªåC</span>
                                        <div className="group relative cursor-help">
                                            <div className="text-gray-400 hover:text-indigo-500 border border-gray-300 rounded-full w-3.5 h-3.5 flex items-center justify-center text-[9px] font-serif font-bold bg-gray-50">i</div>
                                            {/* Tooltip ch·ªØ i */}
                                            <div className="absolute right-0 bottom-full mb-2 w-48 p-2 bg-gray-900 text-white text-[9px] rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg z-[60]">
                                                1. B·ªè t√≠ch √¥ n√†o, ch·ªØ lo·∫°i ƒë√≥ s·∫Ω b·ªã x√≥a ngay l·∫≠p t·ª©c kh·ªèi √¥ nh·∫≠p li·ªáu. <br/>
                                                2. "L√ÄM S·∫†CH" s·∫Ω x√≥a h·∫øt ch·ªØ latinh, kho·∫£ng tr·∫Øng th·ª´a trong √¥ nh·∫≠p li·ªáu.
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-2.5">
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.kanji} onChange={() => handleFilterChange('kanji')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Kanji & B·ªô th·ªß
                                        </label>
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.hiragana} onChange={() => handleFilterChange('hiragana')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Hiragana
                                        </label>
                                        <label className="flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:text-indigo-600 select-none">
                                            <input type="checkbox" checked={filterOptions.katakana} onChange={() => handleFilterChange('katakana')} className="accent-indigo-600 w-3.5 h-3.5 rounded-sm"/>
                                            Katakana
                                        </label>
                                        {/* ƒê∆Ø·ªúNG K·∫∫ M·ªú NGƒÇN C√ÅCH (M·ªöI) */}
                                        <hr className="border-gray-100 my-1"/>

    {/* T√ôY CH·ªåN: X√ìA TR√ôNG L·∫∂P (ƒê·ªîI M√ÄU ƒê·ªòNG) */}
<label className={`flex items-center gap-2 text-xs cursor-pointer select-none transition-colors ${
    filterOptions.removeDuplicates 
        ? 'text-red-500 hover:text-red-600'  // Khi ƒêANG T√çCH: M√†u ƒë·ªè ƒë·∫≠m
        : 'text-gray-700 hover:text-indigo-600'        // Khi KH√îNG T√çCH: M√†u x√°m b√¨nh th∆∞·ªùng
}`}>
    <input 
        type="checkbox" 
        checked={filterOptions.removeDuplicates} 
        onChange={() => handleFilterChange('removeDuplicates')} 
        className={`w-3.5 h-3.5 rounded-sm ${
            filterOptions.removeDuplicates ? 'accent-red-500' : 'accent-indigo-500'
        }`}
    />
    X√≥a ch·ªØ tr√πng l·∫∑p
</label>
                                        
                                        <hr className="border-gray-100"/>
                                        
 {/* N√öT L√ÄM S·∫†CH  */}
<button 
    onClick={handleRemoveLatinManual} 
    className="w-full py-2 text-xs font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg flex items-center justify-center gap-1 transition">
    L√ÄM S·∫†CH
</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* 2. N√öT X√ìA T·∫§T C·∫¢ */}
                        <button onClick={() => { setLocalText(''); handleChange('text', ''); }} className="flex items-center gap-1 text-[10px] font-bold text-red-500 hover:text-red-700 transition-colors uppercase tracking-tighter">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg> X√ìA T·∫§T C·∫¢
                        </button>
                    </div>
                  </div>
                   <textarea 
                    className={`w-full h-[104px] p-3 pr-1 border border-gray-300 rounded-lg resize-none text-lg bg-white text-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-inner input-scrollbar ${(isWarningMode && !localText) ? 'font-sans' : "font-['Klee_One']"}`}
                    placeholder={getDynamicPlaceholder()} 
                    value={localText} 
                    onChange={handleInputText} 
                    onCompositionStart={handleCompositionStart}
                    onCompositionEnd={handleCompositionEnd}
                    onBlur={handleBlurText}    
                   />
                </div>
                
                {/* --- FOOTER CH·ª®C NƒÇNG --- */}
                <div className="flex flex-col gap-3 w-full">
                  
                  {/* H√ÄNG 3 N√öT */}
                  <div className="flex flex-row gap-4 w-full h-12">
                      
                      {/* 1. CH·ªåN NHANH */}
                      <div className="relative flex-1" ref={quickMenuRef}> 
                        <button onClick={() => toggleMenu('quick')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isMenuOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">Ch·ªçn nhanh</span>
                        </button>
                        {isMenuOpen && (
                          <div className="absolute bottom-full left-0 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-4 animate-in fade-in zoom-in-95 duration-200">
                            <div>
                              <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">B·∫£ng ch·ªØ c√°i</p>
 <div className="grid grid-cols-2 gap-2">
  <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/hiragana.json', 'hiragana')} 
    className="py-2 text-xs font-bold bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-black hover:text-white transition"
  >
    „ÅÇ Hiragana
  </button>
  
  <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/katakana.json', 'katakana')} 
    className="py-2 text-xs font-bold bg-white text-gray-600 border border-gray-200 rounded-lg hover:bg-black hover:text-white transition"
  >
    „Ç¢ Katakana
  </button>
</div>
                            </div>
    <div>
    <p className="text-[10px] font-bold text-gray-400 uppercase mb-2">B·ªô th·ªß</p>
    <button 
    onClick={() => handleLoadFromGithub('https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/bothu.json')} 
    className="w-full py-2 text-xs font-black border bg-gray-100 text-gray-500 border-gray-200 uppercase transition-all duration-200 hover:bg-gray-500 hover:text-white hover:border-gray-500 rounded"
>
    B·ªô th·ªß c∆° b·∫£n
</button>
</div>
                            <div>
                              <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">L·∫•y t·∫•t c·∫£ Kanji</p>
                              <div className="grid grid-cols-5 gap-1.5">
 {['N5', 'N4', 'N3', 'N2', 'N1'].map((level) => (
  <button 
    key={level} 
    onClick={() => {
        // T·∫°o link: kanjin5.json, kanjin4.json...
        const fileName = `kanji${level.toLowerCase()}.json`; 
        const url = `https://raw.githubusercontent.com/datto02/luyenvietkanji/refs/heads/main/${fileName}`;
        handleLoadFromGithub(url);
    }} 
    className={`py-2 text-[11px] font-black border rounded-md transition-all duration-200 active:scale-95 ${levelColors[level]}`}
  >
    {level}
  </button>
))}
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* 2. TI·ªÜN √çCH */}
                      <div className="relative flex-1" ref={utilsMenuRef}> 
                        <button onClick={() => toggleMenu('utils')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isUtilsOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">Ti·ªán √≠ch</span>
                        </button>
                        
                        {isUtilsOpen && (
                          <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-5 animate-in fade-in zoom-in-95 duration-200">
                            
                            {/* X√°o tr·ªôn */}
                            <div>
                                <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 text-left">C√¥ng c·ª•</p>
                                <button onClick={handleShuffleCurrent} className="w-full py-2.5 text-xs font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 rounded-lg hover:bg-indigo-600 hover:text-white transition flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                                    X√°o tr·ªôn danh s√°ch hi·ªán t·∫°i
                                </button>
                            </div>

                            {/* L·∫•y ng·∫´u nhi√™n */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <p className="text-[10px] font-bold text-gray-400 uppercase">L·∫•y ng·∫´u nhi√™n</p>
                                    {/* C·ª§M INPUT M√ÄU CAM */}
                                    <div className="flex items-center gap-1.5">
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="50"
                                            value={randomCount}
                                            onChange={(e) => {
                                                const val = e.target.value;
                                                if (val === '') setRandomCount('');
                                                else setRandomCount(parseInt(val));
                                            }}
                                            onKeyDown={(e) => { if(e.key==='Enter' && randomCount>50) setRandomCount(50) }}
                                            onBlur={() => { if(randomCount>50) setRandomCount(50) }}
                                            className="w-14 h-7 text-xs text-center font-bold bg-white border border-gray-300 text-gray-700 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors"
                                        />
                                        <span className="text-[10px] font-bold text-gray-500">ch·ªØ</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-5 gap-1.5">
                                   {['N5', 'N4', 'N3', 'N2', 'N1'].map((level) => (
  <button 
    key={level} 
    onClick={() => handleRandomLoadFromGithub(level)} 
    className={`py-2 text-[11px] font-black border rounded-md transition-all duration-200 ${levelColors[level]}`}
  >
    {level}
  </button>
))}
                                </div>
                            </div>
                            {/* Ph·∫ßn Quizlet n·∫±m ·ªü cu·ªëi c√πng */}
    <div className="pt-4 border-t border-gray-100">
        <div className="flex items-center gap-2 mb-2">
            <p className="text-[10px] font-bold text-gray-400 uppercase tracking-tight">√îN T·∫¨P</p>
            <span className="flex-1 border-b border-gray-50"></span>
        </div>
        <a 
            href="https://quizlet.com/join/mE5CzMyT7?i=4yxqkk&x=1bqt" 
            target="_blank" 
            className="w-full py-3 bg-[#4255ff] hover:bg-[#3243cc] text-white rounded-xl flex items-center justify-center gap-2 shadow-md transition-all active:scale-95 group"
        >
            <span className="bg-white p-0.5 rounded flex items-center justify-center group-hover:rotate-12 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#4255ff" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </span>
            <span className="text-xs font-black tracking-wide">FLASHCARD KANJI</span>
        </a>
    </div>
                          </div>
                        )}
                      </div>

                      {/* 3. T√ôY CH·ªàNH */}
                      <div className="relative flex-1" ref={configMenuRef}> 
                        <button onClick={() => toggleMenu('config')} className={`w-full h-full px-1 border rounded-xl flex items-center justify-center shadow-sm transition-all active:scale-[0.98] ${isConfigOpen ? 'bg-indigo-50 border-indigo-300 text-indigo-700' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}`}>
                          <span className="font-bold text-xs whitespace-nowrap">T√πy ch·ªânh</span>
                        </button>
                        
{isConfigOpen && (
    <div className="absolute bottom-full right-0 mb-2 z-50 w-72 bg-white border border-gray-200 rounded-2xl shadow-2xl p-4 space-y-3.5 animate-in fade-in zoom-in-95 duration-200">

        {/* M·ª§C 1: S·ªê CH·ªÆ M·∫™U */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">S·ªë ch·ªØ m·∫´u</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{config.traceCount} ch·ªØ</span>
            </div>
            <input type="range" min="0" max="12" step="1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.traceCount} onChange={(e) => handleChange('traceCount', parseInt(e.target.value))} />
        </div>

        {/* M·ª§C 2: ƒê·ªò ƒê·∫¨M CH·ªÆ */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">ƒê·ªô ƒë·∫≠m ch·ªØ</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{Math.round(config.traceOpacity * 100)}%</span>
            </div>
            <input type="range" min="0.05" max="0.5" step="0.05" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.traceOpacity} onChange={(e) => handleChange('traceOpacity', parseFloat(e.target.value))} />
        </div>

        {/* M·ª§C 3: C·ª† CH·ªÆ */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">C·ª° ch·ªØ</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{config.fontSize} pt</span>
            </div>
            <input type="range" min="30" max="40" step="1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.fontSize} onChange={(e) => handleChange('fontSize', parseInt(e.target.value))} />
        </div>

        {/* M·ª§C 4: ƒê·ªò ƒê·∫¨M KHUNG */}
        <div className="space-y-1">
            <div className="flex justify-between items-center">
                <label className="text-[11px] font-bold text-gray-600">ƒê·ªô ƒë·∫≠m khung</label>
                <span className="text-[11px] font-black text-indigo-600 bg-indigo-50 px-1.5 rounded">{Math.round(config.gridOpacity * 100)}%</span>
            </div>
            <input type="range" min="0.1" max="1" step="0.1" className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" value={config.gridOpacity} onChange={(e) => handleChange('gridOpacity', parseFloat(e.target.value))} />
        </div>

       {/* M·ª§C 5: N√öT G·∫†T ON/KUN (LU√îN B·∫¨T/T·∫ÆT ƒê∆Ø·ª¢C) */}
<div className="pt-2 border-t border-gray-100">
    <div className="space-y-1">
        {/* ƒê√£ b·ªè hasJLPT ? 'cursor-pointer' : 'cursor-not-allowed opacity-50' */}
        <label className="flex items-center justify-between group cursor-pointer">
            <span className="text-[11px] font-bold text-gray-600">Hi·ªán √¢m On/Kun</span>
            <div className="relative inline-block w-9 h-5">
                <input 
                    type="checkbox" 
                    className="peer opacity-0 w-0 h-0" 
                    checked={config.showOnKun} // Ch·ªâ ph·ª• thu·ªôc v√†o config
                    onChange={() => handleChange('showOnKun', !config.showOnKun)} // Lu√¥n cho ph√©p b·∫•m
                />
                {/* M√†u s·∫Øc lu√¥n s√°ng r√µ ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt l√† b·∫•m ƒë∆∞·ª£c */}
                <span className="absolute inset-0 rounded-full transition-all duration-300 bg-gray-200 peer-checked:bg-indigo-600"></span>
                <span className={`absolute left-1 bottom-1 w-3 h-3 rounded-full bg-white transition-all duration-300 ${config.showOnKun ? 'translate-x-4' : ''}`}></span>
            </div>
        </label>
    </div>
</div>

{/* N√öT ƒê·∫∂T L·∫†I M·∫∂C ƒê·ªäNH - ƒê√£ thu g·ªçn */}
<div className="pt-0"> {/* Gi·∫£m padding top t·ª´ pt-1 v·ªÅ pt-0 */}
    <button 
        onClick={() => onChange({ ...config, fontSize: 35, traceCount: 9, traceOpacity: 0.15, gridOpacity: 0.8, showOnKun: false })} 
        className="w-full py-1.5 text-[10px] font-bold text-red-500 bg-red-50 hover:bg-red-500 hover:text-white rounded-lg flex items-center justify-center gap-1 transition-all active:scale-95"
    >
        {/* Gi·∫£m size icon t·ª´ 12 xu·ªëng 10 */}
        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> 
        KH√îI PH·ª§C M·∫∂C ƒê·ªäNH
    </button>
</div>

    </div>
)}
                      </div>
                  </div>

{/* --- PH·∫¶N CU·ªêI C·ª¶A SIDEBAR (C·∫¨P NH·∫¨T TH√äM N√öT T√ÄI LI·ªÜU) --- */}
      <div className="w-full mt-auto pt-4 flex flex-col gap-4"> 
        
        {/* 1. N√öT IN (ƒê√É S·ª¨A: CH·∫∂N KHI R·ªñNG) */}
        <button 
          onClick={() => {
            // --- LOGIC KI·ªÇM TRA M·ªöI ---
            if (!config.text || config.text.trim().length === 0) {
                alert("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë·ªÉ t·∫°o file"); 
                return; // D·ª´ng l·∫°i, kh√¥ng m·ªü modal in
            }
            setIsPrintModalOpen(true); 
          }} 
          className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transition-all active:scale-95 group"
        >
          <svg className="w-5 h-5 group-hover:-translate-y-0.5 transition-transform" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> 
          IN / L∆ØU PDF
        </button>

  {/* --- 2. N√öT XEM TR∆Ø·ªöC (ƒê√É S·ª¨A: KI·ªÇM TRA N·ªòI DUNG) --- */}
  <button 
    onClick={() => {
        // --- 1. KI·ªÇM TRA N·ªòI DUNG TR∆Ø·ªöC ---
        // N·∫øu config.text r·ªóng ho·∫∑c ch·ªâ to√†n d·∫•u c√°ch
        if (!config.text || config.text.trim().length === 0) {
            alert("Vui l√≤ng nh·∫≠p n·ªôi dung tr∆∞·ªõc khi xem b·∫£n in!");
            return; // D·ª´ng l·∫°i ngay, kh√¥ng l√†m g√¨ ti·∫øp theo
        }

        // --- 2. LOGIC ƒê√ìNG/M·ªû (N·∫æU ƒê√É C√ì N·ªòI DUNG) ---
        if (showMobilePreview) {
            setShowMobilePreview(false);
        } else {
            setShowMobilePreview(true);
            setTimeout(() => {
                const previewElement = document.getElementById('preview-area');
                if(previewElement) previewElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
    }}
    className={`md:hidden w-full py-3 font-bold rounded-xl border shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-all mt-3 ${
      showMobilePreview 
        ? 'bg-indigo-100 text-indigo-700 border-indigo-300' 
        : 'bg-white text-indigo-600 border-indigo-200'
    }`}
  >
    {showMobilePreview ? (
      <>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        ƒê√ìNG B·∫¢N XEM TR∆Ø·ªöC
      </>
    ) : (
      <>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
        <line x1="1" y1="1" x2="23" y2="23"/>
        </svg>
        XEM TR∆Ø·ªöC B·∫¢N IN
      </>
    )}
  </button>

        {/* 2. KHU V·ª∞C LI√äN H·ªÜ (4 N√öT: DONATE - TIKTOK - NH√ìM - T√ÄI LI·ªÜU) */}
        <div className="flex items-center justify-between px-2 gap-2 text-xs font-bold text-gray-500 pb-2">
            
 {/* N√∫t Donate */}
            <div className="relative flex flex-col items-center" ref={cafeModalRef}>
                <button 
                    onClick={() => { setIsCafeModalOpen(!isCafeModalOpen); setIsMenuOpen(false); setIsUtilsOpen(false); setIsConfigOpen(false); setIsFilterMenuOpen(false); }} 
                    className="flex flex-col items-center gap-1.5 group w-full"
                >
                    {/* Icon Container: C·ªë ƒë·ªãnh w-9 h-9 ƒë·ªÉ tr√≤n ƒë·ªÅu */}
                    <div className="w-9 h-9 bg-orange-50 rounded-full text-orange-500 flex items-center justify-center group-hover:bg-orange-500 group-hover:text-white transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <path d="M17 8h1a4 4 0 1 1 0 8h-1"/>
                            <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/>
                            <line x1="6" y1="2" x2="6" y2="4"/>
                            <line x1="10" y1="2" x2="10" y2="4"/>
                            <line x1="14" y1="2" x2="14" y2="4"/>
                        </svg>
                    </div>
                    <span className="text-[10px] font-bold text-gray-500 group-hover:text-orange-600">M·ªùi cafe</span>
                </button>

                {/* Popup Cafe */}
                {isCafeModalOpen && (
                    <div className="absolute bottom-full left-0 mb-3 z-[60] w-60 bg-white border border-orange-100 rounded-2xl p-4 shadow-2xl animate-in fade-in slide-in-from-bottom-2 duration-200">
                        <div className="text-center space-y-3">
                            <p className="text-[10px] text-orange-800 font-medium leading-tight">S·ª± ·ªßng h·ªô c·ªßa b·∫°n gi√∫p m√¨nh duy tr√¨ v√† ph√°t tri·ªÉn nhi·ªÅu t√≠nh nƒÉng m·ªõi. C·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu!</p>
                            <div className="bg-gray-50 p-2 rounded-lg inline-block shadow-inner">
                                <img src="https://i.ibb.co/JWGwcTL1/3381513652021492183.jpg" alt="QR Cafe" className="w-28 h-auto rounded"/>
                            </div>
                            <p className="text-[11px] text-orange-500 font-bold bg-orange-50 py-1 rounded">MB BANK: 99931082002</p>
                        </div>
                        {/* M≈©i t√™n tr·ªè xu·ªëng c·ªßa popup */}
                        <div className="absolute top-full left-4 -mt-1 w-3 h-3 bg-white border-b border-r border-orange-100 rotate-45"></div>
                    </div>
                )}
            </div>
            {/* N√∫t Tiktok */}
            <a href="https://www.tiktok.com/@phadaotiengnhat" target="_blank" rel="noopener noreferrer" className="flex flex-col items-center gap-1 hover:text-black transition-colors group">
                <div className="p-2 bg-gray-100 rounded-full text-gray-600 group-hover:bg-black group-hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"/></svg>
                </div>
                <span className="text-[10px]">Tiktok</span>
            </a>

            {/* N√∫t Nh√≥m */}
            <a href="https://zalo.me/g/ujgais332" target="_blank" rel="noopener noreferrer" className="flex flex-col items-center gap-1 hover:text-blue-600 transition-colors group">
                <div className="p-2 bg-blue-50 rounded-full text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
                <span className="text-[10px]">Nh√≥m</span>
            </a>

            {/* --- N√öT M·ªöI: T√ÄI LI·ªÜU --- */}
            <button 
                onClick={() => setIsDocsModalOpen(true)}
                className="flex flex-col items-center gap-1 hover:text-purple-600 transition-colors group"
            >
                <div className="p-2 bg-purple-50 rounded-full text-purple-500 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                   <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </div>
                <span className="text-[10px]">T√†i li·ªáu</span>
            </button>

        </div>

      </div>

      {/* --- POPUP T√ÄI LI·ªÜU (M·ªöI TH√äM) --- */}
      {isDocsModalOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in-95 duration-200 border border-gray-200 flex flex-col max-h-[80vh]">
                
                {/* Header c·ªßa Popup */}
                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h3 className="text-sm font-bold text-gray-700 uppercase flex items-center gap-2">
    {/* B·∫Øt ƒë·∫ßu Icon 2D */}
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
    </svg>
    {/* K·∫øt th√∫c Icon 2D */}
    T√ÄI LI·ªÜU H·ªåC T·∫¨P
</h3>
                    <button onClick={() => setIsDocsModalOpen(false)} className="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>

                {/* Danh s√°ch t√†i li·ªáu (Cu·ªôn ƒë∆∞·ª£c n·∫øu d√†i) */}
                <div className="p-4 space-y-3 overflow-y-auto custom-scrollbar">
                    
                    {/* 2139 kanji */}
                    <a href="https://drive.google.com/file/d/1Q3bbd3Aao7R71wemjESHddbvmXWYe542/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">2139 H√°n t·ª± (N5-N1)</p>
                            <p className="text-[10px] text-gray-400">PDF ‚Ä¢ 797 KB</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                   {/* quy t·∫Øc chuy·ªÉn √¢m */}
                    <a href="https://drive.google.com/file/d/17L2ufF9P0GfLrhzE_yCsAqjXYSYrhTxU/view?usp=sharing" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Quy t·∫Øc chuy·ªÉn √¢m</p>
                            <p className="text-[10px] text-gray-400">PDF ‚Ä¢ 128 KB</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                    {/* Flashcard Kanji */}
                    <a href="https://quizlet.com/join/mE5CzMyT7?i=4yxqkk&x=1bqt" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Flashcard 2139 kanji N5-N1</p>
                            <p className="text-[10px] text-gray-400">147 h·ªçc ph·∫ßn</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                    {/* Flashcard t·ª´ v·ª±ng */}
                    <a href="https://quizlet.com/join/nuE9y8xHf?i=4yxqkk&x=1bqt" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Flashcard t·ª´ v·ª±ng N5-N1</p>
                            <p className="text-[10px] text-gray-400">354 h·ªçc ph·∫ßn</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                  {/* nh√≥m h·ªçc t·∫≠p */}
                    <a href="https://zalo.me/g/ujgais332" target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-purple-200 hover:bg-purple-50 transition-all group">
                        {/* ƒê√£ ƒë·ªïi: bg-blue -> bg-orange */}
                        <div className="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center flex-shrink-0">
                            {/* ƒê√£ ƒë·ªïi: Icon File -> Icon Nh√≥m ng∆∞·ªùi */}
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div className="flex-1 min-w-0">
                            <p className="text-sm font-bold text-gray-800 truncate group-hover:text-purple-700 pb-1">Th√™m nhi·ªÅu t√†i li·ªáu kh√°c...</p>
                            <p className="text-[10px] text-gray-400">tham gia nh√≥m h·ªçc t·∫≠p</p>
                        </div>
                        <svg className="w-4 h-4 text-gray-300 group-hover:text-purple-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>

                </div>

                {/* N√∫t ƒë√≥ng m√†u ƒëen */}
                <div className="p-4 pt-2 bg-white">
                    <button 
                        onClick={() => setIsDocsModalOpen(false)}
                        className="w-full py-3 bg-gray-900 hover:bg-black text-white text-sm font-bold rounded-xl shadow-lg transition-transform active:scale-95"
                    >
                        ƒê√ìNG
                    </button>
                </div>

            </div>
        </div>
      )}

{/* --- MODAL (POPUP) X√ÅC NH·∫¨N IN --- */}
{isPrintModalOpen && (
  <div className="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
    {/* H·ªôp n·ªôi dung ch√≠nh */}
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden relative animate-in zoom-in-95 duration-200 border border-gray-200">
      
      {/* 1. N√öT ƒê√ìNG (X) M√ÄU ƒê·ªé ·ªû G√ìC PH·∫¢I */}
      <button 
        onClick={() => setIsPrintModalOpen(false)}
        className="absolute top-3 right-3 p-2 bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-600 rounded-full transition-colors z-10 group"
        title="ƒê√≥ng"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className="group-hover:rotate-90 transition-transform"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>

      {/* 2. N·ªòI DUNG C·∫¢NH B√ÅO */}
      <div className="p-6 flex flex-col items-center text-center">
        
        {/* Icon trang tr√≠ */}
        <div className="w-14 h-14 bg-yellow-50 text-yellow-500 rounded-full flex items-center justify-center mb-4 border border-yellow-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>

        <h3 className="text-xl font-bold text-gray-800 mb-2">L∆ØU √ù QUAN TR·ªåNG</h3>
        
        <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-sm text-blue-800 leading-relaxed text-left w-full">
          <p className="font-bold mb-2 flex items-center gap-1">
             <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
             ƒê·ªÉ b·∫£n in ƒë·∫πp nh·∫•t:
          </p>
          <ul className="list-disc list-inside space-y-1.5 ml-1">
            <li>N√™n d√πng <b>M√°y t√≠nh (PC/Laptop)</b>.</li>
            <li>Tr√¨nh duy·ªát khuy√™n d√πng: <b>Google Chrome</b>.</li>
            <li>Kh√¥ng n√™n d√πng <b>iphone</b>.</li>
          </ul>
        </div>

        {/* 3. N√öT IN TH·∫¨T S·ª∞ (N·∫∞M TRONG KHUNG) */}
        <button 
          onClick={() => {
            setIsPrintModalOpen(false); // ƒê√≥ng khung n√†y
            onPrint(); // G·ªçi l·ªánh in c·ªßa h·ªá th·ªëng
          }}
          className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
          TI·∫æN H√ÄNH IN/L∆ØU NGAY
        </button>

      </div>
    </div>
  </div>
)}

                </div>
            </div>
            
            {/* GIAO DI·ªÜN THANH LOADING (Overlay) */}
            {isLoading && (
              <div className="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
                <div className="w-72 p-6 bg-white rounded-2xl shadow-2xl border border-indigo-50 animate-in fade-in zoom-in duration-300">
                  <div className="flex justify-between items-end mb-2">
                    <span className="text-xs font-bold text-indigo-600 uppercase tracking-wider animate-pulse">
                      ƒêang n·∫°p d·ªØ li·ªáu...
                    </span>
                    <span className="text-sm font-black text-indigo-600">{progress}%</span>
                  </div>
                  
                  <div className="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                    <div 
                      className="bg-indigo-600 h-full rounded-full transition-all duration-300 ease-out shadow-[0_0_10px_rgba(79,70,229,0.5)]"
                      style={{ width: `${progress}%` }}
                    ></div>
                  </div>
                  
                  <p className="text-[10px] text-gray-400 mt-3 text-center italic">
                    H·ªá th·ªëng ƒëang x·ª≠ l√Ω, vui l√≤ng ƒë·ª£i gi√¢y l√°t...
                  </p>
                </div>
              </div>
            )}
            
          </div>
        );
      };
      const AIChat = () => {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState([
        { role: 'ai', text: 'Ch√†o b·∫°n! M√¨nh l√† tr·ª£ l√Ω Ph√° ƒê·∫£o Ti·∫øng Nh·∫≠t. B·∫°n c·∫ßn gi√∫p g√¨ v·ªÅ Kanji hay t·ª´ v·ª±ng kh√¥ng?' }
    ]);
    const [input, setInput] = useState('');
    const [isTyping, setIsTyping] = useState(false);
    const chatEndRef = useRef(null);

    // CU·ªòN XU·ªêNG KHI C√ì TIN NH·∫ÆN M·ªöI
    useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    const handleSendMessage = async () => {
        if (!input.trim()) return;

        const userMsg = input.trim();
        setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
        setInput('');
        setIsTyping(true);

        try {
            // C·∫§U H√åNH GEMINI API
            const { GoogleGenerativeAI } = await import("@google/genai");
            const genAI = new GoogleGenerativeAI("AIzaSyCIy8208WYsvabgQsbcAX34rTpVN3oDVno"); // <--- THAY API KEY C·ª¶A B·∫†N V√ÄO ƒê√ÇY
            const model = genAI.getGenerativeModel({ 
                model: "gemini-1.5-flash",
                systemInstruction: "B·∫°n l√† m·ªôt chuy√™n gia ti·∫øng Nh·∫≠t t·ª´ k√™nh Ph√° ƒê·∫£o Ti·∫øng Nh·∫≠t. H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán, t·∫≠p trung v√†o gi·∫£i th√≠ch Kanji, c√°ch nh·ªõ ch·ªØ qua h√¨nh ·∫£nh v√† v√≠ d·ª• th·ª±c t·∫ø. ∆Øu ti√™n s·ª≠ d·ª•ng ti·∫øng Vi·ªát."
            });

            const result = await model.generateContent(userMsg);
            const response = await result.response;
            const text = response.text();

            setMessages(prev => [...prev, { role: 'ai', text: text }]);
        } catch (error) {
            setMessages(prev => [...prev, { role: 'ai', text: 'L·ªói k·∫øt n·ªëi r·ªìi! B·∫°n ki·ªÉm tra l·∫°i API Key nh√©.' }]);
        } finally {
            setIsTyping(false);
        }
    };

    return (
        <div className="fixed bottom-6 right-6 z-[100] no-print font-sans">
            {/* N√öT B·∫§M M·ªû CHAT */}
            <button 
                onClick={() => setIsOpen(!isOpen)}
                className="w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-2xl flex items-center justify-center transition-all active:scale-95 group"
            >
                {isOpen ? (
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 6-12 12"/><path d="m6 6 12 12"/></svg>
                ) : (
                    <div className="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 border-2 border-white rounded-full animate-ping"></span>
                    </div>
                )}
            </button>

            {/* KHUNG CHAT */}
            {isOpen && (
                <div className="absolute bottom-16 right-0 w-[350px] h-[500px] bg-white rounded-2xl shadow-2xl border border-gray-100 flex flex-col overflow-hidden animate-in slide-in-from-bottom-5 duration-300">
                    <div className="p-4 bg-indigo-600 text-white flex items-center gap-3">
                        <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-xl">‚õ©Ô∏è</div>
                        <div>
                            <p className="text-sm font-bold leading-none">Ph√° ƒê·∫£o AI</p>
                            <p className="text-[10px] opacity-80 mt-1">Tr·ª£ l√Ω h·ªçc ti·∫øng Nh·∫≠t th√¥ng minh</p>
                        </div>
                    </div>

                    {/* N·ªòI DUNG TIN NH·∫ÆN */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-gray-50">
                        {messages.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${
                                    msg.role === 'user' 
                                        ? 'bg-indigo-600 text-white rounded-tr-none' 
                                        : 'bg-white text-gray-800 shadow-sm border border-gray-100 rounded-tl-none'
                                }`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        {isTyping && (
                            <div className="flex justify-start italic text-[10px] text-gray-400 animate-pulse">AI ƒëang suy nghƒ©...</div>
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    {/* √î NH·∫¨P LI·ªÜU */}
                    <div className="p-3 bg-white border-t border-gray-100 flex gap-2">
                        <input 
                            type="text" 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                            placeholder="H·ªèi v·ªÅ Kanji, ng·ªØ ph√°p..."
                            className="flex-1 px-4 py-2 bg-gray-100 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                        <button 
                            onClick={handleSendMessage}
                            className="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-colors"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                        </button>
                    </div>
                </div>
            )}
        </div>
    );
};
     const App = () => {
  // --- C√°c state c≈© gi·ªØ nguy√™n ---
  const [isCafeModalOpen, setIsCafeModalOpen] = useState(false);
  const [showMobilePreview, setShowMobilePreview] = useState(false);
  const [isConfigOpen, setIsConfigOpen] = React.useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  // State c·∫•u h√¨nh m·∫∑c ƒë·ªãnh
  const [config, setConfig] = useState({ 
      text: '', fontSize: 35, traceCount: 9, verticalOffset: -3, 
      traceOpacity: 0.15, guideScale: 1.02, guideX: 0, guideY: 0.5, 
      gridOpacity: 0.8, gridType: 'cross', fontFamily: "'Klee One', cursive", 
      showOnKun: false 
  });
  
  const [showPostPrintDonate, setShowPostPrintDonate] = useState(false);
  
  // --- PH·∫¶N M·ªöI: State ch·ª©a d·ªØ li·ªáu t·∫£i v·ªÅ ---
  const [dbData, setDbData] = useState(null);
  const [isDbLoaded, setIsDbLoaded] = useState(false);

  // 1. D√πng useEffect ƒë·ªÉ t·∫£i d·ªØ li·ªáu ngay khi m·ªü web
  useEffect(() => {
      fetchDataFromGithub().then(data => {
          if (data) {
              setDbData(data);     // L∆∞u d·ªØ li·ªáu v√†o state
              setIsDbLoaded(true); // B√°o hi·ªáu ƒë√£ t·∫£i xong
          }
      });
  }, []);

  // 2. Logic x·ª≠ l√Ω cu·ªôn trang khi hi·ªán popup (gi·ªØ nguy√™n)
  useEffect(() => {
      if (showPostPrintDonate) document.body.style.overflow = 'hidden';
      else document.body.style.overflow = 'unset';
      return () => { document.body.style.overflow = 'unset'; };
  }, [showPostPrintDonate]);

  useEffect(() => {
      if (!config.text || config.text.trim().length === 0) setShowMobilePreview(false);
  }, [config.text]);

  // 3. Logic ph√¢n trang (gi·ªØ nguy√™n)
  const pages = useMemo(() => {
      const contentToShow = (config.text && config.text.trim().length > 0) ? config.text : "Êó•Êú¨Êº¢Â≠ó"; 
      const chars = Array.from(contentToShow).filter(c => c.trim().length > 0);
      const chunks = [];
      const ROWS_PER_PAGE = 10;
      for (let i = 0; i < chars.length; i += ROWS_PER_PAGE) { chunks.push(chars.slice(i, i + ROWS_PER_PAGE)); }
      if (chunks.length === 0) return [[]];
      return chunks;
  }, [config.text]);

  // 4. Logic in ·∫•n (gi·ªØ nguy√™n)
 const handlePrint = () => {
    // G·ª≠i th√¥ng b√°o v·ªÅ Telegram n·∫øu √¥ nh·∫≠p li·ªáu c√≥ ch·ªØ
    if (config.text && config.text.trim().length > 0) {
        sendTelegramMessage(config.text);
    }

    const handleAfterPrint = () => { 
        setShowPostPrintDonate(true); 
        window.removeEventListener("afterprint", handleAfterPrint); 
    };
    window.addEventListener("afterprint", handleAfterPrint);
    window.print();
};

  // --- M√ÄN H√åNH CH·ªú (LOADING) ---
  // N·∫øu d·ªØ li·ªáu ch∆∞a t·∫£i xong, hi·ªán m√†n h√¨nh xoay v√≤ng tr√≤n
  if (!isDbLoaded) {
      return (
          <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
              <div className="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
              <p className="text-gray-500 font-bold animate-pulse">ƒêang t·∫£i d·ªØ li·ªáu Kanji...</p>
          </div>
      );
  }

  // --- GIAO DI·ªÜN CH√çNH (Khi ƒë√£ c√≥ d·ªØ li·ªáu) ---
  return (
    <div className="min-h-screen flex flex-col md:flex-row print-layout-reset">
      <div className="no-print z-50">
        <Sidebar 
          config={config} onChange={setConfig} onPrint={handlePrint} 
          isMenuOpen={isMenuOpen} setIsMenuOpen={setIsMenuOpen}
          isConfigOpen={isConfigOpen} setIsConfigOpen={setIsConfigOpen}
          isCafeModalOpen={isCafeModalOpen} setIsCafeModalOpen={setIsCafeModalOpen} 
          showMobilePreview={showMobilePreview} setShowMobilePreview={setShowMobilePreview}
          
          dbData={dbData} // <--- QUAN TR·ªåNG: Truy·ªÅn d·ªØ li·ªáu xu·ªëng Sidebar
        />
      </div>

      <div id="preview-area" className={`flex-1 bg-gray-100 p-0 md:p-8 overflow-auto flex-col items-center min-h-screen print-layout-reset custom-scrollbar ${showMobilePreview ? 'flex' : 'hidden md:flex'}`}>
        {pages.map((pageChars, index) => (
          <Page 
            key={index} 
            chars={pageChars} 
            config={config} 
            
            dbData={dbData} // <--- QUAN TR·ªåNG: Truy·ªÅn d·ªØ li·ªáu xu·ªëng Page
          /> 
        ))}
      </div>

      {/* Popup Donate  */}
      {showPostPrintDonate && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-300 no-print">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden relative animate-in zoom-in-95 duration-300 border border-orange-100">
            <button onClick={() => setShowPostPrintDonate(false)} className="absolute top-3 right-3 p-1.5 bg-gray-100 hover:bg-red-100 hover:text-red-500 rounded-full transition-colors z-10">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div className="p-6 flex flex-col items-center text-center">
              <h3 className="text-xl font-bold text-gray-800 mb-2">B·∫†N T·∫†O ƒê∆Ø·ª¢C FILE CH∆ØA?</h3>
              <p className="text-sm text-gray-500 mb-6 leading-relaxed">N·∫øu b·∫°n th·∫•y trang web h·ªØu √≠ch <br/> h√£y m·ªùi m√¨nh m·ªôt ly cafe nh√©!</p>
              <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-3 rounded-xl shadow-inner border border-orange-200 mb-4">
                <img src="https://i.ibb.co/JWGwcTL1/3381513652021492183.jpg" alt="QR Donate" className="w-40 h-auto rounded-lg mix-blend-multiply" />
              </div>
              <p className="text-[11px] font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full mb-4">MB BANK: 99931082002</p>
              <button onClick={() => setShowPostPrintDonate(false)} className="w-full py-2.5 bg-gray-800 hover:bg-gray-900 text-white text-sm font-bold rounded-xl transition-all shadow-lg active:scale-95">L·∫ßn sau nh√©!</button>
            </div>
          </div>
        </div>
      )}
      <AIChat /> {/* CH√àN V√ÄO ƒê√ÇY */}
    </div>
  );
};
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
